<!DOCTYPE html>
<html lang="en">

<head>
  <title>Danh sách sản phẩm</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

  <div class="container mt-3">
    <h2>Danh sách sản phẩm</h2>
    <table class="table table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên truyện</th>
          <th>Mô tả ngắn</th>
          <th>Tên tác giả</th>
          <th>Năm xuất bản</th>
          <th>Ảnh bìa</th>
          <th>Danh sách các ảnh nội dung truyện</th>
          <th>Thao tác</th>
          <th>Thao tác</th> <!-- Thêm cột mới cho nút sửa -->
        </tr>
      </thead>
      <tbody id="productTableBody">
        <!-- Dòng bảng sẽ được thêm động ở đây -->
      </tbody>
    </table>
  </div>

  <script>
    // Sử dụng Fetch API để gọi endpoint và lấy dữ liệu
    fetch('/products')
      .then(response => response.json())
      .then(products => {
        const tbody = document.getElementById("productTableBody");

        products.forEach(product => {
          const row = document.createElement("tr");
          row.innerHTML = `
                  <td>${product._id}</td>
                  <td>${product.tentruyen}</td>
                  <td>${product.motangan}</td>
                  <td>${product.tentacgia}</td>
                  <td>${product.namxuatban}</td>
                  <!-- Sử dụng thẻ <img> để hiển thị ảnh bìa -->
                  <td>
                  <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 3px solid #eecd9d;">
                  <img src="/images/${product.anhbia.filename}" alt="Ảnh bìa" style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  </td>
                  <td>
            <a href="/pdf/${product.danhsachcacanhnoidungtruyen[0].filename}" target="_blank">Xem PDF</a>
          </td>
                  <td>
                    <button type="button" class="btn btn-danger" onclick="deleteProduct('${product._id}')">Xóa</button>
                  </td>
                  <td>
                    <!-- Thêm nút sửa và gắn sự kiện sửa -->
                    <button type="button" class="btn btn-warning" onclick="editProduct('${product._id}')">Sửa</button>
                  </td>
              `;
          tbody.appendChild(row);
          console.log("Danh sách ảnh nội dung truyện:", product.danhsachcacanhnoidungtruyen);
        });
      })
      .catch(error => {
        console.error("Error fetching products:", error);
      });

    function editProduct(productId,) {
      // Lưu ID sản phẩm vào sessionStorage
      sessionStorage.setItem('editedProductId', productId);

      // Chuyển hướng đến trang "Sửa sản phẩm"
      window.location.href = '/updateProductScreen';
    }

    // Hàm xóa sản phẩm
    function deleteProduct(productId) {
      if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?")) {
        // Gửi yêu cầu xóa đến server
        fetch(`/product/delete/${productId}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            alert(data.message);
            // Reload trang sau khi xóa để cập nhật danh sách sản phẩm
            location.reload();
          })
          .catch(error => {
            console.error("Error deleting product:", error);
            alert("Xóa sản phẩm không thành công.");
          });
      }
    }
  </script>
</body>

</html>